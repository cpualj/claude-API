# Claude API Backend - Testing Suite

å®Œæ•´çš„ Vitest æµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–åç«¯æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ§ª æµ‹è¯•æ¦‚è§ˆ

### æµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•æ–‡ä»¶**: 10ä¸ªä¸»è¦æµ‹è¯•æ–‡ä»¶
- **æµ‹è¯•è¦†ç›–**: æ•°æ®åº“ã€æœåŠ¡å±‚ã€APIè·¯ç”±
- **æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•
- **é¢„æœŸè¦†ç›–ç‡**: >90%

### æµ‹è¯•ç»“æ„
```
tests/
â”œâ”€â”€ setup.js                    # æµ‹è¯•ç¯å¢ƒé…ç½®
â”œâ”€â”€ db/
â”‚   â””â”€â”€ init.test.js            # æ•°æ®åº“åˆå§‹åŒ–å’Œæ“ä½œ
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ redis.test.js           # Redis ç¼“å­˜å’Œé˜Ÿåˆ—æœåŠ¡
â”‚   â”œâ”€â”€ workerManager.test.js   # Worker è¿›ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ apiKeyManager.test.js   # API å¯†é’¥ç®¡ç†
â”‚   â””â”€â”€ sessionManager.test.js  # ä¼šè¯ç®¡ç†
â””â”€â”€ routes/
    â”œâ”€â”€ auth.test.js            # ç”¨æˆ·è®¤è¯è·¯ç”±
    â”œâ”€â”€ api.test.js             # ä¸»è¦ API ç«¯ç‚¹
    â”œâ”€â”€ admin.test.js           # ç®¡ç†å‘˜åŠŸèƒ½
    â””â”€â”€ health.test.js          # å¥åº·æ£€æŸ¥å’Œç›‘æ§
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒæ£€æŸ¥
```bash
npm run test:setup
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. è¿è¡Œæµ‹è¯•
```bash
npm test              # ç›‘è§†æ¨¡å¼
npm run test:run      # è¿è¡Œä¸€æ¬¡
npm run test:ui       # å¯è§†åŒ–ç•Œé¢
npm run test:coverage # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```

## ğŸ“‹ æµ‹è¯•è¯¦æƒ…

### æ•°æ®åº“æµ‹è¯• (tests/db/init.test.js)
- âœ… æ•°æ®åº“è¿æ¥å’Œåˆå§‹åŒ–
- âœ… æ•°æ®åº“æ¶æ„éªŒè¯
- âœ… CRUD æ“ä½œæµ‹è¯•
- âœ… äº‹åŠ¡å¤„ç†
- âœ… é”™è¯¯å¤„ç†

### Redis æœåŠ¡æµ‹è¯• (tests/services/redis.test.js)
- âœ… Redis è¿æ¥ç®¡ç†
- âœ… ä¼šè¯ç¼“å­˜ (SessionCache)
- âœ… Worker çŠ¶æ€ç®¡ç† (WorkerStatusManager)  
- âœ… è¯·æ±‚é˜Ÿåˆ— (RequestQueue)
- âœ… é€Ÿç‡é™åˆ¶ (RateLimiter)
- âœ… TTL å’Œè¿‡æœŸå¤„ç†

### Worker ç®¡ç†æµ‹è¯• (tests/services/workerManager.test.js)
- âœ… Worker æ³¨å†Œå’Œç®¡ç†
- âœ… è¯·æ±‚å¤„ç†å’Œè´Ÿè½½å‡è¡¡
- âœ… é˜Ÿåˆ—ç®¡ç†
- âœ… è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ
- âœ… é”™è¯¯æ¢å¤å’Œé‡å¯
- âœ… ä¼˜é›…å…³é—­

### API å¯†é’¥ç®¡ç†æµ‹è¯• (tests/services/apiKeyManager.test.js)
- âœ… API å¯†é’¥ç”Ÿæˆå’ŒéªŒè¯
- âœ… é€Ÿç‡é™åˆ¶æ£€æŸ¥
- âœ… ä½¿ç”¨æƒ…å†µè®°å½•
- âœ… ç»Ÿè®¡ä¿¡æ¯ç”Ÿæˆ
- âœ… ç¼“å­˜ç®¡ç†
- âœ… å¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

### ä¼šè¯ç®¡ç†æµ‹è¯• (tests/services/sessionManager.test.js)
- âœ… ä¼šè¯åˆ›å»ºå’Œæ£€ç´¢
- âœ… ä¼šè¯æ›´æ–°å’Œåˆ é™¤
- âœ… ä¸Šä¸‹æ–‡ç®¡ç†
- âœ… ä¼šè¯åˆ—è¡¨å’Œè¿‡æ»¤
- âœ… è‡ªåŠ¨æ¸…ç†
- âœ… ç¼“å­˜ç­–ç•¥

### è®¤è¯è·¯ç”±æµ‹è¯• (tests/routes/auth.test.js)
- âœ… ç”¨æˆ·æ³¨å†Œå’ŒéªŒè¯
- âœ… ç™»å½•å’Œ JWT ç”Ÿæˆ
- âœ… ç™»å‡ºå’Œä»¤ç‰Œé»‘åå•
- âœ… ç”¨æˆ·èµ„æ–™ç®¡ç†
- âœ… å¯†ç é‡ç½®æµç¨‹
- âœ… æƒé™éªŒè¯

### API è·¯ç”±æµ‹è¯• (tests/routes/api.test.js)
- âœ… èŠå¤© API (æµå¼å’Œéæµå¼)
- âœ… ä¼šè¯ CRUD æ“ä½œ
- âœ… å·¥å…·åˆ—è¡¨è·å–
- âœ… ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢
- âœ… é…é¢æ£€æŸ¥
- âœ… API å¯†é’¥è®¤è¯

### ç®¡ç†å‘˜è·¯ç”±æµ‹è¯• (tests/routes/admin.test.js)
- âœ… ç”¨æˆ·ç®¡ç† (CRUD)
- âœ… API å¯†é’¥ç®¡ç†
- âœ… ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
- âœ… ç®¡ç†å‘˜æƒé™éªŒè¯
- âœ… å®¡è®¡æ—¥å¿—
- âœ… å®‰å…¨æ§åˆ¶

### å¥åº·æ£€æŸ¥æµ‹è¯• (tests/routes/health.test.js)
- âœ… åŸºç¡€å¥åº·æ£€æŸ¥
- âœ… è¯¦ç»†æœåŠ¡çŠ¶æ€
- âœ… å­˜æ´»å’Œå°±ç»ªæ¢é’ˆ
- âœ… Prometheus æŒ‡æ ‡
- âœ… ç³»ç»Ÿç›‘æ§
- âœ… æ€§èƒ½æŒ‡æ ‡

## ğŸ”§ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡ (.env.test)
```env
NODE_ENV=test
DATABASE_URL=postgresql://postgres:password@localhost:5432/claude_api_test
REDIS_URL=redis://localhost:6380
JWT_SECRET=test-secret-key
MAX_WORKERS=2
DEFAULT_RATE_LIMIT_PER_HOUR=100
```

### Vitest é…ç½® (vitest.config.js)
- æµ‹è¯•ç¯å¢ƒ: Node.js
- è¶…æ—¶è®¾ç½®: 30ç§’
- è¦†ç›–ç‡æä¾›å•†: V8
- å¹¶è¡Œæ‰§è¡Œ: å•çº¿ç¨‹æ¨¡å¼
- è®¾ç½®æ–‡ä»¶: tests/setup.js

## ğŸ“Š è¦†ç›–ç‡ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|----------|
| è¯­å¥è¦†ç›–ç‡ | >90% | ğŸ¯ å¾…æµ‹è¯• |
| åˆ†æ”¯è¦†ç›–ç‡ | >85% | ğŸ¯ å¾…æµ‹è¯• |
| å‡½æ•°è¦†ç›–ç‡ | >90% | ğŸ¯ å¾…æµ‹è¯• |
| è¡Œè¦†ç›–ç‡ | >90% | ğŸ¯ å¾…æµ‹è¯• |

## ğŸ› ï¸ æµ‹è¯•å·¥å…·

### æ ¸å¿ƒä¾èµ–
- **Vitest**: ç°ä»£æµ‹è¯•æ¡†æ¶
- **Supertest**: HTTP æ–­è¨€åº“  
- **Redis Memory Server**: å†…å­˜ Redis å®ä¾‹
- **bcryptjs**: å¯†ç å“ˆå¸Œæµ‹è¯•

### Mock ç­–ç•¥
- **Socket.IO**: å®Œå…¨æ¨¡æ‹Ÿå®æ—¶åŠŸèƒ½
- **Child Process**: æ¨¡æ‹Ÿ Worker è¿›ç¨‹
- **æ–‡ä»¶ç³»ç»Ÿ**: ä¸´æ—¶æ–‡ä»¶å¤„ç†
- **æ—¶é—´æ§åˆ¶**: è¶…æ—¶å’Œ TTL æµ‹è¯•

## ğŸƒâ€â™‚ï¸ è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# æ•°æ®åº“æµ‹è¯•
npx vitest run tests/db/

# æœåŠ¡å±‚æµ‹è¯•  
npx vitest run tests/services/

# è·¯ç”±æµ‹è¯•
npx vitest run tests/routes/

# å•ä¸ªæ–‡ä»¶
npx vitest run tests/services/redis.test.js

# ç›‘è§†æ¨¡å¼
npx vitest tests/services/redis.test.js
```

## ğŸ› è°ƒè¯•æµ‹è¯•

### è¯¦ç»†è¾“å‡º
```bash
npx vitest run --reporter=verbose
LOG_LEVEL=debug npm test
```

### éš”ç¦»é—®é¢˜
```bash
# é¡ºåºæ‰§è¡Œ
npx vitest run --no-threads

# å•æ–‡ä»¶è°ƒè¯•
npx vitest run tests/problematic.test.js --reporter=verbose
```

## ğŸ” æµ‹è¯•æ¨¡å¼

### å¼€å‘æ¨¡å¼
```bash
npm test                    # ç›‘è§†æ–‡ä»¶å˜åŒ–
npm run test:ui            # å¯è§†åŒ–æµ‹è¯•ç•Œé¢
```

### CI/CD æ¨¡å¼
```bash
npm run test:run           # ä¸€æ¬¡æ€§è¿è¡Œ
npm run test:coverage      # ç”Ÿæˆè¦†ç›–ç‡
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

### è´Ÿè½½æµ‹è¯•
- é€Ÿç‡é™åˆ¶æœ‰æ•ˆæ€§
- Worker æ‰©å±•è¡Œä¸º  
- æ•°æ®åº“è¿æ¥æ± 
- ç¼“å­˜æ€§èƒ½è¡¨ç°

### å†…å­˜æµ‹è¯•
- å†…å­˜æ³„æ¼æ£€æµ‹
- ç¼“å­˜å¤§å°é™åˆ¶
- åƒåœ¾å›æ”¶æ•ˆç‡
- èµ„æºæ¸…ç†éªŒè¯

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ PostgreSQL çŠ¶æ€
pg_ctl status

# åˆ›å»ºæµ‹è¯•æ•°æ®åº“
createdb claude_api_test

# é‡ç½®æµ‹è¯•æ•°æ®åº“
dropdb claude_api_test && createdb claude_api_test
```

#### Redis è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ Redis å†…å­˜æœåŠ¡å™¨å®‰è£…
npm install --save-dev redis-memory-server

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :6380
```

#### ç«¯å£å†²çª
```bash
# æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µ
netstat -tulpn | grep :3002

# ç»ˆæ­¢å ç”¨è¿›ç¨‹
kill -9 $(lsof -t -i:3002)
```

#### å†…å­˜ä¸è¶³
```bash
# å¢åŠ  Node.js å†…å­˜é™åˆ¶
NODE_OPTIONS="--max-old-space-size=4096" npm test
```

## ğŸ“ æœ€ä½³å®è·µ

### ç¼–å†™æµ‹è¯•
1. **æè¿°æ€§å‘½å**: æ¸…æ™°çš„æµ‹è¯•æè¿°
2. **å•ä¸€æ–­è¨€**: æ¯ä¸ªæµ‹è¯•ä¸€ä¸ªæ¦‚å¿µ
3. **AAA æ¨¡å¼**: å®‰æ’-æ‰§è¡Œ-æ–­è¨€
4. **é”™è¯¯æµ‹è¯•**: æµ‹è¯•æˆåŠŸå’Œå¤±è´¥è·¯å¾„
5. **è¾¹ç•Œæƒ…å†µ**: è¾¹ç•Œæ¡ä»¶å’Œé™åˆ¶

### æµ‹è¯•ç»„ç»‡
1. **é€»è¾‘åˆ†ç»„**: ç›¸å…³æµ‹è¯•æ”¾åœ¨ä¸€èµ·
2. **è®¾ç½®/æ¸…ç†**: é€‚å½“çš„èµ„æºç®¡ç†
3. **éš”ç¦»æ€§**: æµ‹è¯•é—´ä¸ç›¸äº’ä¾èµ–
4. **æ€§èƒ½**: å¿«é€Ÿåé¦ˆå¾ªç¯

### ç»´æŠ¤
1. **å®šæœŸæ›´æ–°**: ä¿æŒæµ‹è¯•ä¸ä»£ç åŒæ­¥
2. **ä¸ç¨³å®šæµ‹è¯•**: ä¿®å¤æˆ–åˆ é™¤ä¸å¯é æµ‹è¯•
3. **è¦†ç›–ç‡ç›‘æ§**: ç»´æŒé«˜è¦†ç›–ç‡
4. **æ–‡æ¡£æ›´æ–°**: ä¿æŒæµ‹è¯•æ–‡æ¡£æœ€æ–°

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] è¾¾åˆ° 90% ä»£ç è¦†ç›–ç‡
- [ ] é›†æˆ GitHub Actions CI
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å®Œå–„é”™è¯¯åœºæ™¯æµ‹è¯•

### é•¿æœŸç›®æ ‡
- [ ] æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶
- [ ] å®ç°æµ‹è¯•æ•°æ®å·¥å‚
- [ ] æ·»åŠ è§†è§‰å›å½’æµ‹è¯•
- [ ] é›†æˆå®‰å…¨æµ‹è¯•å·¥å…·

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Vitest å®˜æ–¹æ–‡æ¡£](https://vitest.dev/)
- [Supertest ä½¿ç”¨æŒ‡å—](https://github.com/visionmedia/supertest)
- [Node.js æµ‹è¯•æœ€ä½³å®è·µ](https://github.com/goldbergyoni/javascript-testing-best-practices)
- [Claude API åç«¯æ¶æ„](./README.md)